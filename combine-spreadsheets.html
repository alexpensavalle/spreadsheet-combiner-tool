<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Master Contact Database - 22,000+ Records</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 30px;
            margin: 25px 0;
            text-align: center;
        }

        .upload-section.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .file-input-group {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .file-input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .file-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background: white;
        }

        .file-status {
            margin-top: 5px;
            font-size: 0.9em;
        }

        .status-ready { color: #28a745; }
        .status-missing { color: #dc3545; }
        .status-optional { color: #6c757d; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 2.8em;
            margin: 0;
            font-weight: bold;
        }

        .stat-card p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .progress-section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }

        .progress-bar {
            width: 100%;
            height: 35px;
            background: #e9ecef;
            border-radius: 20px;
            overflow: hidden;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #6c757d !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        .alert {
            padding: 20px;
            margin: 25px 0;
            border-radius: 10px;
            border: 1px solid #bee5eb;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #e8f7fa 100%);
            color: #0c5460;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-color: #ffeaa7;
        }

        .log-section {
            margin-top: 30px;
            padding: 20px;
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            height: 350px;
            overflow-y: auto;
            border: 2px solid #34495e;
        }

        .log-section div {
            margin: 3px 0;
            padding: 2px 0;
        }

        .sample-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .sample-table th,
        .sample-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }

        .sample-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .sample-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóÇÔ∏è Complete Master Contact Database Generator</h1>
            <p>Upload your contact files and generate a unified database with 22,000+ contacts</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <h3>üìÅ Upload Your Contact Files</h3>
            <p>Select your contact files below. The tool will process any combination of files you provide.</p>
            
            <div class="file-input-group">
                <label for="sudFile">Community SUD Workers List by Community.xlsx</label>
                <input type="file" id="sudFile" class="file-input" accept=".xlsx,.xls" />
                <div class="file-status status-missing" id="sudStatus">No file selected</div>
            </div>

            <div class="file-input-group">
                <label for="newContactsFile">new contacts 1.docx</label>
                <input type="file" id="newContactsFile" class="file-input" accept=".docx,.txt" />
                <div class="file-status status-missing" id="newContactsStatus">No file selected</div>
            </div>

            <div class="file-input-group">
                <label for="nhContactsFile">hospital contacts nh.docx</label>
                <input type="file" id="nhContactsFile" class="file-input" accept=".docx,.txt" />
                <div class="file-status status-missing" id="nhContactsStatus">No file selected</div>
            </div>

            <div class="file-input-group">
                <label for="justinFile">Justin Report 3.xls</label>
                <input type="file" id="justinFile" class="file-input" accept=".xlsx,.xls" />
                <div class="file-status status-missing" id="justinStatus">No file selected</div>
            </div>

            <div class="file-input-group">
                <label for="reportFile">report1666054943665 2 1.xlsx</label>
                <input type="file" id="reportFile" class="file-input" accept=".xlsx,.xls" />
                <div class="file-status status-missing" id="reportStatus">No file selected</div>
            </div>
        </div>

        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è File Upload Instructions:</strong><br>
            ‚Ä¢ Upload any combination of your contact files above<br>
            ‚Ä¢ Excel files (.xlsx, .xls) and Word documents (.docx) are supported<br>
            ‚Ä¢ The tool will process whatever files you provide and combine them into one master database<br>
            ‚Ä¢ Large files may take several minutes to process
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="totalCount">0</h3>
                <p>Total Contacts</p>
            </div>
            <div class="stat-card">
                <h3 id="providerCount">0</h3>
                <p>Healthcare Providers</p>
            </div>
            <div class="stat-card">
                <h3 id="patientCount">0</h3>
                <p>Patient Records</p>
            </div>
            <div class="stat-card">
                <h3 id="phoneCount">0</h3>
                <p>With Phone Numbers</p>
            </div>
        </div>

        <div class="progress-section">
            <h3>üîÑ Processing Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%">Ready to Start</div>
            </div>
            <div id="progressText">Upload your files and click "Generate Complete Database" to begin...</div>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" id="generateBtn" onclick="generateCompleteDatabase()">
                üöÄ Generate Complete Database
            </button>
            <button class="btn btn-success" id="downloadBtn" onclick="downloadExcel()" disabled>
                üì• Download Excel File
            </button>
            <button class="btn btn-info" id="csvBtn" onclick="downloadCSV()" disabled>
                üìÑ Download CSV File
            </button>
        </div>

        <div class="alert alert-info">
            <strong>üí° What This Does:</strong><br>
            ‚Ä¢ Extracts every single contact from your uploaded files<br>
            ‚Ä¢ Cleans and standardizes phone numbers, emails, and names<br>
            ‚Ä¢ Categorizes contacts by type (SUD Workers, Healthcare Providers, Patients)<br>
            ‚Ä¢ Preserves source file tracking and insurance information<br>
            ‚Ä¢ Creates downloadable Excel file with proper formatting
        </div>

        <div class="log-section" id="processingLog">
            <div>Master Contact Database Generator v3.0</div>
            <div>Upload your files above and click "Generate Complete Database"</div>
            <div>=====================================</div>
        </div>

        <div id="sampleResults" style="display: none;">
            <h3>üìä Sample Results</h3>
            <table class="sample-table">
                <thead>
                    <tr>
                        <th>Organization</th>
                        <th>Title</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Category</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody id="sampleTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Global variables
        let allContacts = [];
        let isProcessing = false;
        let uploadedFiles = {};

        // Helper functions for data cleaning
        function cleanPhoneNumber(phone) {
            if (!phone) return '';
            try {
                let cleaned = String(phone).replace(/[^\d\-\(\)\+\s]/g, '');
                return cleaned.trim().replace(/\s+/g, ' ');
            } catch (e) {
                return '';
            }
        }

        function cleanName(name) {
            if (!name) return '';
            try {
                return String(name).trim();
            } catch (e) {
                return '';
            }
        }

        function cleanEmail(email) {
            if (!email) return '';
            try {
                return String(email).trim().toLowerCase();
            } catch (e) {
                return '';
            }
        }

        // Logging function
        function log(message) {
            try {
                const logElement = document.getElementById('processingLog');
                const timestamp = new Date().toLocaleTimeString();
                logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                logElement.scrollTop = logElement.scrollHeight;
            } catch (e) {
                console.log(message);
            }
        }

        // Progress update function
        function updateProgress(percent, text) {
            try {
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                
                progressBar.style.width = Math.max(0, Math.min(100, percent)) + '%';
                progressBar.textContent = Math.round(percent) + '%';
                progressText.textContent = text || '';
            } catch (e) {
                console.log(`Progress: ${percent}% - ${text}`);
            }
        }

        // Statistics update function
        function updateStats() {
            try {
                const providers = allContacts.filter(c => c.category !== 'Patient/Client').length;
                const patients = allContacts.filter(c => c.category === 'Patient/Client').length;
                const withPhones = allContacts.filter(c => c.phone && c.phone.trim()).length;

                document.getElementById('totalCount').textContent = allContacts.length.toLocaleString();
                document.getElementById('providerCount').textContent = providers.toLocaleString();
                document.getElementById('patientCount').textContent = patients.toLocaleString();
                document.getElementById('phoneCount').textContent = withPhones.toLocaleString();
            } catch (e) {
                console.log('Error updating stats:', e);
            }
        }

        // File upload handlers
        function setupFileHandlers() {
            const fileInputs = ['sudFile', 'newContactsFile', 'nhContactsFile', 'justinFile', 'reportFile'];
            
            fileInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                const status = document.getElementById(inputId.replace('File', 'Status'));
                
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        uploadedFiles[inputId] = file;
                        status.textContent = `‚úÖ ${file.name} (${(file.size / 1024 / 1024).toFixed(1)} MB)`;
                        status.className = 'file-status status-ready';
                        log(`üìÅ File uploaded: ${file.name}`);
                    } else {
                        delete uploadedFiles[inputId];
                        status.textContent = 'No file selected';
                        status.className = 'file-status status-missing';
                    }
                });
            });
        }

        // Read file as array buffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Show sample results
        function showSampleResults() {
            try {
                const sampleSection = document.getElementById('sampleResults');
                const tbody = document.getElementById('sampleTableBody');
                
                // Get samples from different categories
                const sudWorkers = allContacts.filter(c => c.category === 'SUD Worker').slice(0, 3);
                const providers = allContacts.filter(c => c.category === 'Healthcare Provider').slice(0, 3);
                const patients = allContacts.filter(c => c.category === 'Patient/Client').slice(0, 4);
                
                const samples = [...sudWorkers, ...providers, ...patients];

                tbody.innerHTML = samples.map(contact => `
                    <tr>
                        <td>${contact.organization || 'N/A'}</td>
                        <td>${contact.title || 'N/A'}</td>
                        <td>${contact.name || 'N/A'}</td>
                        <td>${contact.phone || 'N/A'}</td>
                        <td>${contact.category || 'N/A'}</td>
                        <td>${contact.source || 'N/A'}</td>
                    </tr>
                `).join('');

                sampleSection.style.display = 'block';
            } catch (e) {
                console.log('Error showing sample results:', e);
            }
        }

        // Main database generation function
        async function generateCompleteDatabase() {
            if (isProcessing) {
                log('‚ö†Ô∏è Processing already in progress...');
                return;
            }

            if (Object.keys(uploadedFiles).length === 0) {
                alert('Please upload at least one file before generating the database!');
                log('‚ùå No files uploaded');
                return;
            }
            
            try {
                isProcessing = true;
                const generateBtn = document.getElementById('generateBtn');
                const downloadBtn = document.getElementById('downloadBtn');
                const csvBtn = document.getElementById('csvBtn');
                
                generateBtn.disabled = true;
                generateBtn.textContent = '‚è≥ Processing...';
                downloadBtn.disabled = true;
                csvBtn.disabled = true;
                
                allContacts = [];
                
                log('üöÄ Starting complete database generation...');
                updateProgress(0, 'Initializing...');

                // Check if XLSX library is available
                if (typeof XLSX === 'undefined') {
                    throw new Error('XLSX library not loaded. Please refresh the page and try again.');
                }

                let processedFiles = 0;
                const totalFiles = Object.keys(uploadedFiles).length;

                // Process each uploaded file
                for (const [inputId, file] of Object.entries(uploadedFiles)) {
                    const progress = (processedFiles / totalFiles) * 90;
                    
                    switch (inputId) {
                        case 'sudFile':
                            await processSUDWorkers(file);
                            break;
                        case 'newContactsFile':
                            await processTextFile(file, 'New Contacts Document');
                            break;
                        case 'nhContactsFile':
                            await processTextFile(file, 'NH Hospital Contacts');
                            break;
                        case 'justinFile':
                            await processJustinReport(file);
                            break;
                        case 'reportFile':
                            await processLargeReport(file);
                            break;
                    }
                    
                    processedFiles++;
                    updateProgress(progress, `Processed ${processedFiles}/${totalFiles} files...`);
                }

                updateProgress(100, 'Processing complete!');
                log(`‚úÖ Database generation complete! Total contacts: ${allContacts.length.toLocaleString()}`);
                
                // Calculate and display final statistics
                const byCategory = {};
                const bySource = {};
                allContacts.forEach(contact => {
                    byCategory[contact.category] = (byCategory[contact.category] || 0) + 1;
                    bySource[contact.source] = (bySource[contact.source] || 0) + 1;
                });

                log('üìà Final Statistics:');
                Object.entries(byCategory).forEach(([cat, count]) => {
                    log(`  ${cat}: ${count.toLocaleString()}`);
                });

                updateStats();
                showSampleResults();

                // Enable download buttons
                downloadBtn.disabled = false;
                csvBtn.disabled = false;
                generateBtn.textContent = '‚úÖ Database Generated';
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                updateProgress(0, 'Error occurred');
                
                const generateBtn = document.getElementById('generateBtn');
                generateBtn.disabled = false;
                generateBtn.textContent = 'üöÄ Generate Complete Database';
            } finally {
                isProcessing = false;
            }
        }

        // Process SUD Workers file
        async function processSUDWorkers(file) {
            try {
                log(`üìã Processing ${file.name}...`);
                
                const arrayBuffer = await readFileAsArrayBuffer(file);
                const workbook = XLSX.read(arrayBuffer);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                let count = 0;
                for (let i = 3; i < data.length; i++) {
                    const row = data[i];
                    if (row && row[0]) {
                        allContacts.push({
                            organization: cleanName(row[0]),
                            title: cleanName(row[1]),
                            name: cleanName(row[2]),
                            phone: cleanPhoneNumber(row[3]),
                            email: cleanEmail(row[4]),
                            alternateContact: cleanName(row[5]),
                            source: 'Community SUD Workers',
                            category: 'SUD Worker'
                        });
                        count++;
                    }
                }
                log(`‚úÖ SUD Workers: ${count} records added`);
            } catch (error) {
                log(`‚ö†Ô∏è Error processing SUD Workers file: ${error.message}`);
            }
        }

        // Process text files
        async function processTextFile(file, source) {
            try {
                log(`üìÑ Processing ${file.name}...`);
                
                const text = await readFileAsText(file);
                const contacts = parseTextContacts(text, source);
                allContacts.push(...contacts);
                log(`‚úÖ ${source}: ${contacts.length} records added`);
            } catch (error) {
                log(`‚ö†Ô∏è Error processing ${file.name}: ${error.message}`);
            }
        }

        // Parse text contacts helper function
        function parseTextContacts(text, source) {
            const contacts = [];
            try {
                const lines = text.split('\n').filter(line => line.trim());
                let currentOrganization = '';

                const phoneRegex = /(\d{3}[-.\s]?\d{3}[-.\s]?\d{4}|\(\d{3}\)\s?\d{3}[-.\s]?\d{4}|1[-.\s]?800[-.\s]?\d{3}[-.\s]?\d{4})/g;
                const emailRegex = /<([^>]+@[^>]+)>|([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;

                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;

                    if (line.includes(':') && !line.includes('@')) {
                        const parts = line.split(':');
                        currentOrganization = parts[0].trim();
                        
                        if (parts[1] && parts[1].trim()) {
                            const info = parts[1].trim();
                            const phoneMatch = info.match(phoneRegex);
                            if (phoneMatch) {
                                contacts.push({
                                    organization: currentOrganization,
                                    title: info.replace(phoneRegex, '').trim() || 'Staff',
                                    name: '',
                                    phone: cleanPhoneNumber(phoneMatch[0]),
                                    email: '',
                                    alternateContact: '',
                                    source: source,
                                    category: 'Healthcare Provider'
                                });
                            }
                        }
                    }
                    else if (line.includes('@')) {
                        const emailMatch = line.match(emailRegex);
                        if (emailMatch) {
                            const email = emailMatch[1] || emailMatch[2];
                            let name = line.includes('<') ? line.split('<')[0].trim() : '';
                            
                            contacts.push({
                                organization: currentOrganization || 'Healthcare Provider',
                                title: 'Staff',
                                name: name,
                                phone: '',
                                email: cleanEmail(email),
                                alternateContact: '',
                                source: source,
                                category: 'Healthcare Provider'
                            });
                        }
                    }
                    else {
                        const phoneMatch = line.match(phoneRegex);
                        if (phoneMatch) {
                            let nameAndTitle = line.replace(phoneMatch[0], '').trim();
                            
                            contacts.push({
                                organization: currentOrganization || 'Healthcare Provider',
                                title: nameAndTitle || 'Staff',
                                name: nameAndTitle || '',
                                phone: cleanPhoneNumber(phoneMatch[0]),
                                email: '',
                                alternateContact: '',
                                source: source,
                                category: 'Healthcare Provider'
                            });
                        }
                    }
                }
            } catch (error) {
                log(`Error parsing text contacts: ${error.message}`);
            }
            return contacts;
        }

        // Process Justin Report
        async function processJustinReport(file) {
            try {
                log(`üè• Processing ${file.name}...`);
                
                const arrayBuffer = await readFileAsArrayBuffer(file);
                const workbook = XLSX.read(arrayBuffer);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                let justinCount = 0;
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (row && (row[1] || row[0])) {
                        const name = cleanName(row[1] || row[0]);
                        const phone = cleanPhoneNumber(row[2]);
                        const insurance = cleanName(row[3]);
                        const policyId = cleanName(row[4]);
                        
                        if (name) {
                            allContacts.push({
                                organization: insurance || 'Unknown Insurance',
                                title: 'Patient/Client',
                                name: name,
                                phone: phone,
                                email: '',
                                alternateContact: policyId ? `Policy: ${policyId}` : '',
                                source: 'Justin Report',
                                category: 'Patient/Client'
                            });
                            justinCount++;
                        }
                    }
                }
                log(`‚úÖ Justin Report: ${justinCount} patient records added`);
            } catch (error) {
                log(`‚ö†Ô∏è Error processing Justin Report: ${error.message}`);
            }
        }

        // Process large report file
        async function processLargeReport(file) {
            try {
                log(`üìä Processing ${file.name}...`);
                
                const arrayBuffer = await readFileAsArrayBuffer(file);
                const workbook = XLSX.read(arrayBuffer);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                const totalRows = range.e.r + 1;
                log(`üìä Large report has ${totalRows.toLocaleString()} total rows`);
                
                // Process in chunks to avoid memory issues
                const chunkSize = 1000;
                let reportCount = 0;
                
                for (let startRow = 0; startRow < totalRows; startRow += chunkSize) {
                    const endRow = Math.min(startRow + chunkSize - 1, range.e.r);
                    const chunkRange = `A${startRow + 1}:H${endRow + 1}`;
                    
                    try {
                        const chunkData = XLSX.utils.sheet_to_json(worksheet, {header: 1, range: chunkRange});
                        
                        for (let row of chunkData) {
                            if (row && row[0]) {
                                const name = cleanName(row[0]);
                                const phone1 = cleanPhoneNumber(row[2]);
                                const phone2 = cleanPhoneNumber(row[3]);
                                const insurance = cleanName(row[4]);
                                const altPhone = cleanPhoneNumber(row[5]);
                                const referringOrg = cleanName(row[7]);
                                
                                const primaryPhone = phone1 || phone2 || altPhone;
                                
                                if (name) {
                                    allContacts.push({
                                        organization: referringOrg || insurance || 'Patient Records',
                                        title: 'Patient/Client',
                                        name: name,
                                        phone: primaryPhone,
                                        email: '',
                                        alternateContact: insurance || '',
                                        source: 'Report File',
                                        category: 'Patient/Client'
                                    });
                                    reportCount++;
                                }
                            }
                        }
                        
                        // Allow UI to update
                        await new Promise(resolve => setTimeout(resolve, 10));
                        
                    } catch (chunkError) {
                        log(`‚ö†Ô∏è Error in chunk ${startRow}-${endRow}: ${chunkError.message}`);
                        break;
                    }
                }
                
                log(`‚úÖ Large report: ${reportCount.toLocaleString()} patient records added`);
            } catch (error) {
                log(`‚ö†Ô∏è Error processing large report: ${error.message}`);
            }
        }

        // Download Excel file
        function downloadExcel() {
            if (allContacts.length === 0) {
                alert('Please generate the database first!');
                return;
            }

            try {
                log('üì• Creating Excel file...');
                
                const headers = ['Organization', 'Title/Position', 'Name', 'Phone', 'Email', 'Alternate Contact', 'Source File', 'Category'];
                const excelData = [headers];
                
                allContacts.forEach(contact => {
                    excelData.push([
                        contact.organization || '',
                        contact.title || '',
                        contact.name || '',
                        contact.phone || '',
                        contact.email || '',
                        contact.alternateContact || '',
                        contact.source || '',
                        contact.category || ''
                    ]);
                });

                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                
                // Set column widths for better readability
                worksheet['!cols'] = [
                    { wch: 25 }, { wch: 25 }, { wch: 20 }, { wch: 15 }, 
                    { wch: 30 }, { wch: 20 }, { wch: 25 }, { wch: 15 }
                ];
                
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Master Contact List');

                // Create summary sheet
                const byCategory = {};
                const bySource = {};
                const withPhones = allContacts.filter(c => c.phone && c.phone.trim()).length;
                const withEmails = allContacts.filter(c => c.email && c.email.trim()).length;
                
                allContacts.forEach(contact => {
                    byCategory[contact.category] = (byCategory[contact.category] || 0) + 1;
                    bySource[contact.source] = (bySource[contact.source] || 0) + 1;
                });

                const summaryData = [
                    ['Master Contact Database Summary', ''],
                    ['Generated on:', new Date().toLocaleString()],
                    ['Total Contacts:', allContacts.length],
                    ['', ''],
                    ['By Category:', ''],
                    ...Object.entries(byCategory).map(([cat, count]) => [cat, count]),
                    ['', ''],
                    ['By Source File:', ''],
                    ...Object.entries(bySource).map(([source, count]) => [source, count]),
                    ['', ''],
                    ['Data Quality:', ''],
                    ['Records with Phone Numbers:', withPhones],
                    ['Records with Email Addresses:', withEmails],
                    ['Records with Both Phone & Email:', allContacts.filter(c => c.phone && c.email).length]
                ];

                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                summarySheet['!cols'] = [{ wch: 30 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');
                
                XLSX.writeFile(workbook, `Complete_Master_Contact_Database_${allContacts.length}_Records.xlsx`);
                log(`‚úÖ Excel file downloaded with ${allContacts.length.toLocaleString()} contacts!`);
            } catch (error) {
                log(`‚ùå Error creating Excel file: ${error.message}`);
                alert('Error creating Excel file. Please try again.');
            }
        }

        // Download CSV file
        function downloadCSV() {
            if (allContacts.length === 0) {
                alert('Please generate the database first!');
                return;
            }

            try {
                log('üìÑ Creating CSV file...');
                
                const headers = ['Organization', 'Title/Position', 'Name', 'Phone', 'Email', 'Alternate Contact', 'Source File', 'Category'];
                let csvContent = headers.join(',') + '\n';
                
                allContacts.forEach(contact => {
                    const row = [
                        `"${(contact.organization || '').replace(/"/g, '""')}"`,
                        `"${(contact.title || '').replace(/"/g, '""')}"`,
                        `"${(contact.name || '').replace(/"/g, '""')}"`,
                        `"${(contact.phone || '').replace(/"/g, '""')}"`,
                        `"${(contact.email || '').replace(/"/g, '""')}"`,
                        `"${(contact.alternateContact || '').replace(/"/g, '""')}"`,
                        `"${(contact.source || '').replace(/"/g, '""')}"`,
                        `"${(contact.category || '').replace(/"/g, '""')}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Complete_Master_Contact_Database_${allContacts.length}_Records.csv`;
                link.click();
                
                log(`‚úÖ CSV file downloaded with ${allContacts.length.toLocaleString()} contacts!`);
            } catch (error) {
                log(`‚ùå Error creating CSV file: ${error.message}`);
                alert('Error creating CSV file. Please try again.');
            }
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            try {
                setupFileHandlers();
                log('üéØ Master Contact Database Generator ready!');
                log('üìÅ Upload your contact files above to get started.');
                log('‚úÖ XLSX library loaded successfully');
            } catch (error) {
                console.log('Initialization error:', error);
            }
        });
    </script>
</body>
</html>