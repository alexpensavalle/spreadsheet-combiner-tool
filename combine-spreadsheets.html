<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Master Contact Database - 22,000+ Records</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 30px;
            margin: 25px 0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: #007bff;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .upload-header h3 {
            color: #2c3e50;
            margin: 0;
        }

        .add-file-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 50px;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .add-file-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .file-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .file-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .file-icon {
            font-size: 24px;
            margin-right: 15px;
            color: #007bff;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .file-meta {
            font-size: 0.9em;
            color: #6c757d;
        }

        .file-status {
            margin-left: 15px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-ready {
            background: #d4edda;
            color: #155724;
        }

        .status-processing {
            background: #fff3cd;
            color: #856404;
        }

        .status-complete {
            background: #d1ecf1;
            color: #0c5460;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .drop-zone {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            margin: 20px 0;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .drop-zone.active {
            background: #e3f2fd;
            border-color: #0056b3;
        }

        .drop-zone h4 {
            color: #007bff;
            margin-bottom: 10px;
        }

        .drop-zone p {
            color: #6c757d;
            margin-bottom: 15px;
        }

        .browse-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .browse-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .ai-summary-section {
            margin: 30px 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card h3 {
            font-size: 1.8em;
            margin: 0 0 20px 0;
            font-weight: bold;
            text-align: center;
        }

        .summary-content {
            font-size: 1.1em;
            line-height: 1.6;
            opacity: 0.95;
        }

        .summary-content p {
            margin: 15px 0;
        }

        .summary-content .highlight {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        .summary-content .metric {
            color: #ffd700;
            font-weight: bold;
        }

        .progress-section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }

        .progress-bar {
            width: 100%;
            height: 35px;
            background: #e9ecef;
            border-radius: 20px;
            overflow: hidden;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #6c757d !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        .alert {
            padding: 20px;
            margin: 25px 0;
            border-radius: 10px;
            border: 1px solid #bee5eb;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #e8f7fa 100%);
            color: #0c5460;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-color: #c3e6cb;
        }

        .log-section {
            margin-top: 30px;
            padding: 20px;
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            height: 350px;
            overflow-y: auto;
            border: 2px solid #34495e;
        }

        .log-section div {
            margin: 3px 0;
            padding: 2px 0;
        }

        .sample-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .sample-table th,
        .sample-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }

        .sample-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .sample-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }

            .upload-header {
                flex-direction: column;
                gap: 15px;
            }

            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🗂️ Flexible Master Contact Database Generator</h1>
            <p>Upload any contact files from your computer and generate a unified database</p>
        </div>

        <div class="upload-section">
            <div class="upload-header">
                <h3>📁 Upload Your Contact Files</h3>
                <button class="add-file-btn" onclick="addFileInput()" title="Add another file">+</button>
            </div>
            
            <div class="drop-zone" id="dropZone">
                <h4>📎 Drag & Drop Files Here</h4>
                <p>Or click below to browse your computer</p>
                <button class="browse-btn" onclick="triggerFileInput()">📂 Browse Files</button>
                <input type="file" id="hiddenFileInput" class="hidden" multiple accept=".xlsx,.xls,.docx,.txt,.csv" onchange="handleFileSelect(event)">
            </div>

            <div class="file-list" id="fileList">
                <!-- Uploaded files will appear here -->
            </div>
        </div>

        <div class="alert alert-success" style="display: none;" id="uploadAlert">
            <strong>✅ Files Ready!</strong><br>
            <span id="fileCount">0</span> file(s) uploaded and ready for processing.
        </div>

        <div class="ai-summary-section" id="aiSummary" style="display: none;">
            <div class="summary-card">
                <h3>🤖 AI Data Analysis Summary</h3>
                <div class="summary-content" id="summaryContent">
                    <p>Upload and process your files to see an intelligent analysis of your contact database...</p>
                </div>
            </div>
        </div>

        <div class="progress-section">
            <h3>🔄 Processing Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%">Ready to Start</div>
            </div>
            <div id="progressText">Upload your files above and click "Generate Complete Database" to begin...</div>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" id="generateBtn" onclick="generateCompleteDatabase()">
                🚀 Generate Complete Database
            </button>
            <button class="btn btn-success" id="downloadBtn" onclick="downloadExcel()" disabled>
                📥 Download Excel File
            </button>
            <button class="btn btn-info" id="csvBtn" onclick="downloadCSV()" disabled>
                📄 Download CSV File
            </button>
        </div>

        <div class="alert alert-info">
            <strong>💡 Supported File Types:</strong><br>
            • Excel files (.xlsx, .xls) - Patient databases, contact lists<br>
            • Word documents (.docx) - Contact information, provider lists<br>
            • Text files (.txt) - Any contact data in text format<br>
            • CSV files (.csv) - Spreadsheet data in comma-separated format
        </div>

        <div class="log-section" id="processingLog">
            <div>Master Contact Database Generator v4.0</div>
            <div>Upload any contact files using the + button or drag & drop</div>
            <div>=====================================</div>
        </div>

        <div id="sampleResults" style="display: none;">
            <h3>📊 Sample Results</h3>
            <table class="sample-table">
                <thead>
                    <tr>
                        <th>Organization</th>
                        <th>Title</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Category</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody id="sampleTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Global variables
        let allContacts = [];
        let isProcessing = false;
        let uploadedFiles = new Map();
        let fileCounter = 0;

        // Helper functions for data cleaning
        function cleanPhoneNumber(phone) {
            if (!phone) return '';
            try {
                let cleaned = String(phone).replace(/[^\d\-\(\)\+\s]/g, '');
                return cleaned.trim().replace(/\s+/g, ' ');
            } catch (e) {
                return '';
            }
        }

        function cleanName(name) {
            if (!name) return '';
            try {
                return String(name).trim();
            } catch (e) {
                return '';
            }
        }

        function cleanEmail(email) {
            if (!email) return '';
            try {
                return String(email).trim().toLowerCase();
            } catch (e) {
                return '';
            }
        }

        // Logging function
        function log(message) {
            try {
                const logElement = document.getElementById('processingLog');
                const timestamp = new Date().toLocaleTimeString();
                logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                logElement.scrollTop = logElement.scrollHeight;
            } catch (e) {
                console.log(message);
            }
        }

        // Progress update function
        function updateProgress(percent, text) {
            try {
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                
                progressBar.style.width = Math.max(0, Math.min(100, percent)) + '%';
                progressBar.textContent = Math.round(percent) + '%';
                progressText.textContent = text || '';
            } catch (e) {
                console.log(`Progress: ${percent}% - ${text}`);
            }
        }

        // Generate AI-powered data summary
        function generateAISummary() {
            try {
                if (allContacts.length === 0) {
                    document.getElementById('aiSummary').style.display = 'none';
                    return;
                }

                const summarySection = document.getElementById('aiSummary');
                const summaryContent = document.getElementById('summaryContent');
                
                // Calculate key metrics
                const totalContacts = allContacts.length;
                const providers = allContacts.filter(c => c.category !== 'Patient/Client').length;
                const patients = allContacts.filter(c => c.category === 'Patient/Client').length;
                const withPhones = allContacts.filter(c => c.phone && c.phone.trim()).length;
                const withEmails = allContacts.filter(c => c.email && c.email.trim()).length;
                const phoneRate = ((withPhones / totalContacts) * 100).toFixed(1);
                const emailRate = ((withEmails / totalContacts) * 100).toFixed(1);
                
                // Analyze sources
                const sources = {};
                allContacts.forEach(contact => {
                    sources[contact.source] = (sources[contact.source] || 0) + 1;
                });
                const sourceCount = Object.keys(sources).length;
                const largestSource = Object.entries(sources).sort((a, b) => b[1] - a[1])[0];
                
                // Analyze organizations
                const orgs = {};
                allContacts.forEach(contact => {
                    if (contact.organization && contact.organization !== 'Unknown' && contact.organization !== 'Unknown Insurance') {
                        orgs[contact.organization] = (orgs[contact.organization] || 0) + 1;
                    }
                });
                const uniqueOrgs = Object.keys(orgs).length;
                
                // Analyze categories
                const categories = {};
                allContacts.forEach(contact => {
                    categories[contact.category] = (categories[contact.category] || 0) + 1;
                });
                
                // Generate intelligent summary
                let summary = `<p>Your master contact database has been successfully created from <span class="highlight">${sourceCount} source files</span>, consolidating <span class="metric">${totalContacts.toLocaleString()} contacts</span> into a unified system.</p>`;
                
                // Data composition analysis
                if (patients > providers) {
                    summary += `<p>The database is <span class="highlight">patient-focused</span>, containing <span class="metric">${patients.toLocaleString()} patient records</span> and <span class="metric">${providers} healthcare providers</span>. This suggests a comprehensive patient management system with supporting provider network data.</p>`;
                } else if (providers > patients) {
                    summary += `<p>The database is <span class="highlight">provider-focused</span>, containing <span class="metric">${providers} healthcare providers</span> and <span class="metric">${patients.toLocaleString()} patient records</span>. This indicates a robust healthcare provider directory with patient contact information.</p>`;
                } else {
                    summary += `<p>The database shows a <span class="highlight">balanced mix</span> of <span class="metric">${providers} healthcare providers</span> and <span class="metric">${patients.toLocaleString()} patient records</span>, indicating comprehensive healthcare network coverage.</p>`;
                }
                
                // Data quality analysis
                if (phoneRate >= 80) {
                    summary += `<p><span class="highlight">Excellent contact quality:</span> <span class="metric">${phoneRate}%</span> of records include phone numbers, ensuring strong communication capabilities across your network.</p>`;
                } else if (phoneRate >= 60) {
                    summary += `<p><span class="highlight">Good contact quality:</span> <span class="metric">${phoneRate}%</span> of records have phone numbers. Consider data enrichment for the remaining ${(100 - phoneRate).toFixed(1)}% to improve communication reach.</p>`;
                } else {
                    summary += `<p><span class="highlight">Contact quality opportunity:</span> Only <span class="metric">${phoneRate}%</span> of records have phone numbers. Data enrichment could significantly improve communication capabilities.</p>`;
                }
                
                // Source analysis
                if (largestSource) {
                    const sourcePercent = ((largestSource[1] / totalContacts) * 100).toFixed(1);
                    summary += `<p>Your largest data source, <span class="highlight">${largestSource[0]}</span>, contributes <span class="metric">${sourcePercent}%</span> (${largestSource[1].toLocaleString()} contacts) of your total database.</p>`;
                }
                
                // Organizational diversity
                if (uniqueOrgs > 100) {
                    summary += `<p>The database demonstrates <span class="highlight">extensive network reach</span> with <span class="metric">${uniqueOrgs} unique organizations</span>, indicating comprehensive healthcare ecosystem coverage.</p>`;
                } else if (uniqueOrgs > 50) {
                    summary += `<p>The database shows <span class="highlight">solid network diversity</span> with <span class="metric">${uniqueOrgs} unique organizations</span> represented across your contacts.</p>`;
                }
                
                // Recommendations
                summary += `<p><strong>Next Steps:</strong> Your unified database is ready for import into CRM systems, patient management platforms, or provider directories. Consider implementing data governance policies to maintain quality as the database grows.</p>`;
                
                summaryContent.innerHTML = summary;
                summarySection.style.display = 'block';
                
            } catch (e) {
                console.log('Error generating AI summary:', e);
            }
        }

        // Legacy function for compatibility (redirects to AI summary)
        function updateStats() {
            generateAISummary();
        }

        // File management functions
        function getFileIcon(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            switch (ext) {
                case 'xlsx':
                case 'xls':
                    return '📊';
                case 'docx':
                    return '📄';
                case 'txt':
                    return '📝';
                case 'csv':
                    return '📋';
                default:
                    return '📁';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function addFileToList(file) {
            const fileId = `file_${++fileCounter}`;
            uploadedFiles.set(fileId, file);
            
            const fileList = document.getElementById('fileList');
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.id = fileId;
            
            fileItem.innerHTML = `
                <div class="file-info">
                    <div class="file-icon">${getFileIcon(file.name)}</div>
                    <div class="file-details">
                        <div class="file-name">${file.name}</div>
                        <div class="file-meta">${formatFileSize(file.size)} • ${file.type || 'Unknown type'}</div>
                    </div>
                </div>
                <div class="file-status status-ready">Ready</div>
                <button class="remove-btn" onclick="removeFile('${fileId}')" title="Remove file">×</button>
            `;
            
            fileList.appendChild(fileItem);
            updateUploadAlert();
            log(`📁 Added file: ${file.name}`);
        }

        function removeFile(fileId) {
            uploadedFiles.delete(fileId);
            const fileElement = document.getElementById(fileId);
            if (fileElement) {
                fileElement.remove();
            }
            updateUploadAlert();
            log(`🗑️ Removed file`);
        }

        function updateUploadAlert() {
            const alert = document.getElementById('uploadAlert');
            const fileCount = document.getElementById('fileCount');
            const count = uploadedFiles.size;
            
            if (count > 0) {
                fileCount.textContent = count;
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }
        }

        // File input functions
        function addFileInput() {
            document.getElementById('hiddenFileInput').click();
        }

        function triggerFileInput() {
            document.getElementById('hiddenFileInput').click();
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                // Check if file already exists
                const exists = Array.from(uploadedFiles.values()).some(f => 
                    f.name === file.name && f.size === file.size
                );
                
                if (!exists) {
                    addFileToList(file);
                } else {
                    log(`⚠️ File ${file.name} already uploaded`);
                }
            });
            
            // Reset the input
            event.target.value = '';
        }

        // Drag and drop functionality
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            dropZone.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight() {
                dropZone.classList.add('active');
            }

            function unhighlight() {
                dropZone.classList.remove('active');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = Array.from(dt.files);
                
                files.forEach(file => {
                    const exists = Array.from(uploadedFiles.values()).some(f => 
                        f.name === file.name && f.size === file.size
                    );
                    
                    if (!exists) {
                        addFileToList(file);
                    }
                });
            }
        }

        // File reading functions
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Show sample results
        function showSampleResults() {
            try {
                const sampleSection = document.getElementById('sampleResults');
                const tbody = document.getElementById('sampleTableBody');
                
                // Get samples from different categories
                const sudWorkers = allContacts.filter(c => c.category === 'SUD Worker').slice(0, 3);
                const providers = allContacts.filter(c => c.category === 'Healthcare Provider').slice(0, 3);
                const patients = allContacts.filter(c => c.category === 'Patient/Client').slice(0, 4);
                
                const samples = [...sudWorkers, ...providers, ...patients];

                tbody.innerHTML = samples.map(contact => `
                    <tr>
                        <td>${contact.organization || 'N/A'}</td>
                        <td>${contact.title || 'N/A'}</td>
                        <td>${contact.name || 'N/A'}</td>
                        <td>${contact.phone || 'N/A'}</td>
                        <td>${contact.category || 'N/A'}</td>
                        <td>${contact.source || 'N/A'}</td>
                    </tr>
                `).join('');

                sampleSection.style.display = 'block';
            } catch (e) {
                console.log('Error showing sample results:', e);
            }
        }

        function updateFileStatus(fileId, status, text) {
            try {
                const fileElement = document.getElementById(fileId);
                if (fileElement) {
                    const statusElement = fileElement.querySelector('.file-status');
                    statusElement.className = `file-status status-${status}`;
                    statusElement.textContent = text;
                }
            } catch (e) {
                console.log('Error updating file status:', e);
            }
        }

        // Main database generation function
        async function generateCompleteDatabase() {
            if (isProcessing) {
                log('⚠️ Processing already in progress...');
                return;
            }

            if (uploadedFiles.size === 0) {
                alert('Please upload at least one file before generating the database!');
                log('❌ No files uploaded');
                return;
            }
            
            try {
                isProcessing = true;
                const generateBtn = document.getElementById('generateBtn');
                const downloadBtn = document.getElementById('downloadBtn');
                const csvBtn = document.getElementById('csvBtn');
                
                generateBtn.disabled = true;
                generateBtn.textContent = '⏳ Processing...';
                downloadBtn.disabled = true;
                csvBtn.disabled = true;
                
                allContacts = [];
                
                log('🚀 Starting complete database generation...');
                updateProgress(0, 'Initializing...');

                // Check if XLSX library is available
                if (typeof XLSX === 'undefined') {
                    throw new Error('XLSX library not loaded. Please refresh the page and try again.');
                }

                let processedFiles = 0;
                const totalFiles = uploadedFiles.size;

                // Process each uploaded file
                for (const [fileId, file] of uploadedFiles) {
                    const progress = (processedFiles / totalFiles) * 90;
                    updateProgress(progress, `Processing ${file.name}...`);
                    updateFileStatus(fileId, 'processing', 'Processing...');
                    
                    await processFile(file, fileId);
                    
                    processedFiles++;
                    updateFileStatus(fileId, 'complete', 'Complete');
                    generateAISummary();
                }

                updateProgress(100, 'Processing complete!');
                log(`✅ Database generation complete! Total contacts: ${allContacts.length.toLocaleString()}`);
                
                // Calculate and display final statistics
                const byCategory = {};
                const bySource = {};
                allContacts.forEach(contact => {
                    byCategory[contact.category] = (byCategory[contact.category] || 0) + 1;
                    bySource[contact.source] = (bySource[contact.source] || 0) + 1;
                });

                log('📈 Final Statistics:');
                Object.entries(byCategory).forEach(([cat, count]) => {
                    log(`  ${cat}: ${count.toLocaleString()}`);
                });

                generateAISummary();
                showSampleResults();

                // Enable download buttons
                downloadBtn.disabled = false;
                csvBtn.disabled = false;
                generateBtn.textContent = '✅ Database Generated';
                
            } catch (error) {
                log(`❌ Error: ${error.message}`);
                updateProgress(0, 'Error occurred');
                
                const generateBtn = document.getElementById('generateBtn');
                generateBtn.disabled = false;
                generateBtn.textContent = '🚀 Generate Complete Database';
            } finally {
                isProcessing = false;
            }
        }

        // Process individual file based on type
        async function processFile(file, fileId) {
            try {
                const filename = file.name.toLowerCase();
                const extension = filename.split('.').pop();
                
                log(`📄 Processing ${file.name}...`);
                
                switch (extension) {
                    case 'xlsx':
                    case 'xls':
                        await processExcelFile(file);
                        break;
                    case 'docx':
                        await processWordFile(file);
                        break;
                    case 'txt':
                        await processTextFile(file);
                        break;
                    case 'csv':
                        await processCSVFile(file);
                        break;
                    default:
                        // Try to process as text file
                        await processTextFile(file);
                        break;
                }
                
                log(`✅ ${file.name}: Processing complete`);
            } catch (error) {
                log(`⚠️ Error processing ${file.name}: ${error.message}`);
                updateFileStatus(fileId, 'error', 'Error');
            }
        }

        // Process Excel files
        async function processExcelFile(file) {
            const arrayBuffer = await readFileAsArrayBuffer(file);
            const workbook = XLSX.read(arrayBuffer);
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(worksheet, {header: 1});

            // Determine file type based on content structure
            const isSUDWorkers = data.some(row => 
                row && typeof row[0] === 'string' && 
                (row[0].includes('Arlington') || row[0].includes('Recovery'))
            );
            
            const isPatientData = data.some(row => 
                row && (row[3] === 'BCBS' || row[3] === 'Amerihealth' || row[4] === 'Policy')
            );

            let count = 0;
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || !row[0]) continue;

                if (isSUDWorkers && i >= 3) {
                    // SUD Workers format
                    allContacts.push({
                        organization: cleanName(row[0]),
                        title: cleanName(row[1]),
                        name: cleanName(row[2]),
                        phone: cleanPhoneNumber(row[3]),
                        email: cleanEmail(row[4]),
                        alternateContact: cleanName(row[5]),
                        source: file.name,
                        category: 'SUD Worker'
                    });
                    count++;
                } else if (isPatientData) {
                    // Patient data format
                    const name = cleanName(row[1] || row[0]);
                    const phone = cleanPhoneNumber(row[2]);
                    const insurance = cleanName(row[3]);
                    const policyId = cleanName(row[4]);
                    
                    if (name) {
                        allContacts.push({
                            organization: insurance || 'Unknown Insurance',
                            title: 'Patient/Client',
                            name: name,
                            phone: phone,
                            email: '',
                            alternateContact: policyId ? `Policy: ${policyId}` : '',
                            source: file.name,
                            category: 'Patient/Client'
                        });
                        count++;
                    }
                } else {
                    // Generic Excel format - try to extract what we can
                    const name = cleanName(row[0]);
                    const phone1 = cleanPhoneNumber(row[2]);
                    const phone2 = cleanPhoneNumber(row[3]);
                    const insurance = cleanName(row[4]);
                    const referringOrg = cleanName(row[7] || row[6] || row[5]);
                    
                    const primaryPhone = phone1 || phone2;
                    
                    if (name) {
                        allContacts.push({
                            organization: referringOrg || insurance || 'Unknown',
                            title: 'Patient/Client',
                            name: name,
                            phone: primaryPhone,
                            email: '',
                            alternateContact: insurance || '',
                            source: file.name,
                            category: 'Patient/Client'
                        });
                        count++;
                    }
                }
            }
            
            log(`📊 Extracted ${count} contacts from Excel file`);
        }

        // Process Word/text files
        async function processWordFile(file) {
            const text = await readFileAsText(file);
            await processTextFile(file, text);
        }

        async function processTextFile(file, textContent = null) {
            const text = textContent || await readFileAsText(file);
            const contacts = parseTextContacts(text, file.name);
            allContacts.push(...contacts);
            log(`📝 Extracted ${contacts.length} contacts from text file`);
        }

        // Process CSV files
        async function processCSVFile(file) {
            const text = await readFileAsText(file);
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            
            let count = 0;
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                if (row.length < 2) continue;
                
                const name = cleanName(row[0]);
                if (name) {
                    allContacts.push({
                        organization: cleanName(row[1]) || 'Unknown',
                        title: cleanName(row[2]) || 'Contact',
                        name: name,
                        phone: cleanPhoneNumber(row[3]),
                        email: cleanEmail(row[4]),
                        alternateContact: cleanName(row[5]),
                        source: file.name,
                        category: 'Contact'
                    });
                    count++;
                }
            }
            
            log(`📋 Extracted ${count} contacts from CSV file`);
        }

        // Parse text contacts helper function
        function parseTextContacts(text, source) {
            const contacts = [];
            try {
                const lines = text.split('\n').filter(line => line.trim());
                let currentOrganization = '';

                const phoneRegex = /(\d{3}[-.\s]?\d{3}[-.\s]?\d{4}|\(\d{3}\)\s?\d{3}[-.\s]?\d{4}|1[-.\s]?800[-.\s]?\d{3}[-.\s]?\d{4})/g;
                const emailRegex = /<([^>]+@[^>]+)>|([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;

                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;

                    if (line.includes(':') && !line.includes('@')) {
                        const parts = line.split(':');
                        currentOrganization = parts[0].trim();
                        
                        if (parts[1] && parts[1].trim()) {
                            const info = parts[1].trim();
                            const phoneMatch = info.match(phoneRegex);
                            if (phoneMatch) {
                                contacts.push({
                                    organization: currentOrganization,
                                    title: info.replace(phoneRegex, '').trim() || 'Staff',
                                    name: '',
                                    phone: cleanPhoneNumber(phoneMatch[0]),
                                    email: '',
                                    alternateContact: '',
                                    source: source,
                                    category: 'Healthcare Provider'
                                });
                            }
                        }
                    }
                    else if (line.includes('@')) {
                        const emailMatch = line.match(emailRegex);
                        if (emailMatch) {
                            const email = emailMatch[1] || emailMatch[2];
                            let name = line.includes('<') ? line.split('<')[0].trim() : '';
                            
                            contacts.push({
                                organization: currentOrganization || 'Healthcare Provider',
                                title: 'Staff',
                                name: name,
                                phone: '',
                                email: cleanEmail(email),
                                alternateContact: '',
                                source: source,
                                category: 'Healthcare Provider'
                            });
                        }
                    }
                    else {
                        const phoneMatch = line.match(phoneRegex);
                        if (phoneMatch) {
                            let nameAndTitle = line.replace(phoneMatch[0], '').trim();
                            
                            contacts.push({
                                organization: currentOrganization || 'Healthcare Provider',
                                title: nameAndTitle || 'Staff',
                                name: nameAndTitle || '',
                                phone: cleanPhoneNumber(phoneMatch[0]),
                                email: '',
                                alternateContact: '',
                                source: source,
                                category: 'Healthcare Provider'
                            });
                        }
                    }
                }
            } catch (error) {
                log(`Error parsing text contacts: ${error.message}`);
            }
            return contacts;
        }

        // Download Excel file
        function downloadExcel() {
            if (allContacts.length === 0) {
                alert('Please generate the database first!');
                return;
            }

            try {
                log('📥 Creating Excel file...');
                
                const headers = ['Organization', 'Title/Position', 'Name', 'Phone', 'Email', 'Alternate Contact', 'Source File', 'Category'];
                const excelData = [headers];
                
                allContacts.forEach(contact => {
                    excelData.push([
                        contact.organization || '',
                        contact.title || '',
                        contact.name || '',
                        contact.phone || '',
                        contact.email || '',
                        contact.alternateContact || '',
                        contact.source || '',
                        contact.category || ''
                    ]);
                });

                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                
                // Set column widths for better readability
                worksheet['!cols'] = [
                    { wch: 25 }, { wch: 25 }, { wch: 20 }, { wch: 15 }, 
                    { wch: 30 }, { wch: 20 }, { wch: 25 }, { wch: 15 }
                ];
                
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Master Contact List');

                // Create summary sheet
                const byCategory = {};
                const bySource = {};
                const withPhones = allContacts.filter(c => c.phone && c.phone.trim()).length;
                const withEmails = allContacts.filter(c => c.email && c.email.trim()).length;
                
                allContacts.forEach(contact => {
                    byCategory[contact.category] = (byCategory[contact.category] || 0) + 1;
                    bySource[contact.source] = (bySource[contact.source] || 0) + 1;
                });

                const summaryData = [
                    ['Master Contact Database Summary', ''],
                    ['Generated on:', new Date().toLocaleString()],
                    ['Total Contacts:', allContacts.length],
                    ['Files Processed:', uploadedFiles.size],
                    ['', ''],
                    ['By Category:', ''],
                    ...Object.entries(byCategory).map(([cat, count]) => [cat, count]),
                    ['', ''],
                    ['By Source File:', ''],
                    ...Object.entries(bySource).map(([source, count]) => [source, count]),
                    ['', ''],
                    ['Data Quality:', ''],
                    ['Records with Phone Numbers:', withPhones],
                    ['Records with Email Addresses:', withEmails],
                    ['Records with Both Phone & Email:', allContacts.filter(c => c.phone && c.email).length]
                ];

                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                summarySheet['!cols'] = [{ wch: 30 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');
                
                XLSX.writeFile(workbook, `Master_Contact_Database_${allContacts.length}_Records.xlsx`);
                log(`✅ Excel file downloaded with ${allContacts.length.toLocaleString()} contacts!`);
            } catch (error) {
                log(`❌ Error creating Excel file: ${error.message}`);
                alert('Error creating Excel file. Please try again.');
            }
        }

        // Download CSV file
        function downloadCSV() {
            if (allContacts.length === 0) {
                alert('Please generate the database first!');
                return;
            }

            try {
                log('📄 Creating CSV file...');
                
                const headers = ['Organization', 'Title/Position', 'Name', 'Phone', 'Email', 'Alternate Contact', 'Source File', 'Category'];
                let csvContent = headers.join(',') + '\n';
                
                allContacts.forEach(contact => {
                    const row = [
                        `"${(contact.organization || '').replace(/"/g, '""')}"`,
                        `"${(contact.title || '').replace(/"/g, '""')}"`,
                        `"${(contact.name || '').replace(/"/g, '""')}"`,
                        `"${(contact.phone || '').replace(/"/g, '""')}"`,
                        `"${(contact.email || '').replace(/"/g, '""')}"`,
                        `"${(contact.alternateContact || '').replace(/"/g, '""')}"`,
                        `"${(contact.source || '').replace(/"/g, '""')}"`,
                        `"${(contact.category || '').replace(/"/g, '""')}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Master_Contact_Database_${allContacts.length}_Records.csv`;
                link.click();
                
                log(`✅ CSV file downloaded with ${allContacts.length.toLocaleString()} contacts!`);
            } catch (error) {
                log(`❌ Error creating CSV file: ${error.message}`);
                alert('Error creating CSV file. Please try again.');
            }
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            try {
                setupDragAndDrop();
                log('🎯 Master Contact Database Generator ready!');
                log('📁 Click the + button or drag & drop to upload files.');
                log('✅ XLSX library loaded successfully');
            } catch (error) {
                console.log('Initialization error:', error);
            }
        });
    </script>
</body>
</html>